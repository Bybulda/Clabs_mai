# Семафоры System V

Семафоры живут в ядре, преднащначены для синхронизации, целочисленная переменная способная принимать $\dots$ аргументов


### Разделяемая память(Share memory)

Разделяемая память:
 - shget(просим дескриптор) -- возвращает нетипизированный указатель
 - shmat
 - shmdt
 - shmctl

 Допустим, есть сервер(что-то умеет) и разделяемая память
 Сервер что-то берет из разделяемой памяти, клиенты хотят получить к ней доступ

 Допустим, есть 2 семафора(создает сервер, память он тоже создает)
 [0][1] - стартовые значения, индексация идет с нуля

 Server   [0][1]   CLIENT
 op(-1;0)  op(0;-1) $\to$ [0][0] (Взаимодействие с раздел памятью)

 Далее клиент выполняет op(1;0) $\to$ [1][0], потом клиент блокирует себя вызовом op(-1;-1), сервер разблокирует клиента, выполняя op(1;1) $\to$ [1][1](взаимод с раздел памятью $\to$ [0][0]), далее op(-1;0), далее вызов op(0;1) $\to$ [0][1]

### API семафоров, функции для работы с ними

```c
int semget(key_t key, int num_sem, int flag); // идентификаторб количество, флаги возвращает дескриптор

int semop(int semfd, struct sembuf* opPtr, int len) // семаф-дескриптор, структура сембаф, длина;

struct sembuf{
  short sem_num; // индекс семафора
  short sem_op; // операция над смафором
  short sem_flag; // флаги
};
```
Вызов неблокируещего вызова
IPC_NOWAIT

SEM_UNDO - ядро должно отслеживать значение семафора, вызванного semop, если процесс завершился, все последствия отменяются

функция
```c
int semctl(int sd(дескриптор), int num, int cmd, union semun arg)
union semun{
  int val; // значение семафора
  struct semid_ds* buf; // управление параметрами
  unsigned short* array; // массив значений семафоров
};
```
